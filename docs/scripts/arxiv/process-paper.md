# process-paper 使用说明

## 概述

`process-paper` 脚本用于处理单个 arXiv 论文，从 arXiv API 获取论文元数据并存储到数据库中。

## 功能特性

- 支持处理指定的单个论文
- 如果论文不存在则自动创建
- 自动处理状态管理（pending → processing → completed/failed）
- 详细的处理日志输出
- 错误处理和状态回滚

## 使用方法

### 基本用法

```bash
pnpm run process-paper <arxivId>
```

### 参数说明

- `arxivId`: 必需参数，指定要处理的论文 arXiv ID
  - 示例: `2503.15888`
  - 示例: `2401.12345`

## 使用示例

### 示例 1：处理指定的论文

```bash
pnpm run process-paper 2503.15888
```

**输出示例**：
```
============================================================
开始处理论文: 2503.15888
============================================================
论文 2503.15888 不存在于数据库中，正在创建...
论文 2503.15888 已创建

[1/1] 处理论文: 2503.15888
------------------------------------------------------------
更新状态为: processing
  [1/3] 正在从 arXiv API 获取论文数据...
  [1/3] 请求 URL: https://export.arxiv.org/api/query?id_list=2503.15888
  [1/3] 成功获取响应，响应长度: 12345 字符
  [2/3] 正在解析 XML 数据...
  [2/3] XML 解析完成
  [3/3] 正在提取论文信息...
  [3/3] 提取完成:
      标题: 论文标题
      作者: 作者1, 作者2
      发布日期: 2025-03-25
      主分类: cs.AI
      所有分类: cs.AI, cs.LG
      许可证: http://creativecommons.org/licenses/by/4.0/
      DOI: 10.1234/example.doi
保存论文数据到数据库...
保存作者信息...
保存分类信息...
论文处理完成: 2503.15888
------------------------------------------------------------

============================================================
论文处理完成
============================================================
```

### 示例 2：处理已存在的论文

```bash
pnpm run process-paper 2503.15888
```

**输出示例**：
```
============================================================
开始处理论文: 2503.15888
============================================================
[1/1] 处理论文: 2503.15888
------------------------------------------------------------
更新状态为: processing
  [1/3] 正在从 arXiv API 获取论文数据...
  [1/3] 请求 URL: https://export.arxiv.org/api/query?id_list=2503.15888
  [1/3] 成功获取响应，响应长度: 12345 字符
  [2/3] 正在解析 XML 数据...
  [2/3] XML 解析完成
  [3/3] 正在提取论文信息...
  [3/3] 提取完成:
      标题: 论文标题
      作者: 作者1, 作者2
      发布日期: 2025-03-25
      主分类: cs.AI
      所有分类: cs.AI, cs.LG
      许可证: http://creativecommons.org/licenses/by/4.0/
      DOI: 10.1234/example.doi
保存论文数据到数据库...
保存作者信息...
保存分类信息...
论文处理完成: 2503.15888
------------------------------------------------------------

============================================================
论文处理完成
============================================================
```

## 处理流程

### 1. 查找或创建论文

- 如果论文不存在，创建新记录，状态为 `pending`
- 如果论文已存在，使用现有记录

### 2. 更新状态为处理中

```typescript
await prisma.arxivPaper.update({
  where: { id: paper.id },
  data: { status: 'processing' }
});
```

### 3. 获取论文数据

从 arXiv API 获取论文元数据：
- 标题
- 摘要
- 发布日期
- 主分类
- 所有分类
- 许可证
- arXiv 更新时间
- 评论
- 期刊引用
- DOI
- 作者信息（姓名和机构）

### 4. 解析并保存数据

解析 XML 响应并更新数据库记录：
- 保存论文基本信息到 ArxivPaper 表
- 保存作者信息到 ArxivAuthorName 表
- 保存分类信息到 ArxivCategory 表

### 5. 更新状态

- 成功：`completed`
- 失败：`failed`

## 状态说明

| 状态 | 说明 | 是否处理 |
|------|------|----------|
| `pending` | 待处理 | 是 |
| `processing` | 处理中 | 否（跳过） |
| `completed` | 已完成 | 否（跳过） |
| `failed` | 失败 | 是（重试） |

## 错误处理

### 常见错误

1. **网络错误**
   - arXiv API 无法访问
   - 请求超时
   - 解决方法：检查网络连接，稍后重试

2. **论文不存在**
   - arXiv ID 错误
   - 论文已被删除
   - 解决方法：验证 arXiv ID 是否正确

3. **XML 解析错误**
   - API 响应格式异常
   - 解决方法：检查 arXiv API 状态

4. **数据库错误**
   - 数据库连接失败
   - 解决方法：检查数据库配置，运行 `pnpm run prisma:migrate`

### 重试失败论文

如果论文处理失败，可以手动重试：

```bash
# 直接重新运行命令
pnpm run process-paper {arxivId}
```

## 查看处理结果

### 使用 Prisma Studio

```bash
pnpm run prisma:studio
```

在浏览器中打开 `http://localhost:5555`，可以：
- 查看所有论文记录
- 查看处理状态
- 手动修改状态
- 查看论文元数据

## 注意事项

1. **API 限制**
   - 遵守 arXiv API 使用规范
   - 避免过于频繁的请求

2. **状态管理**
   - 处理中的论文不会重复处理
   - 已完成的论文不会重复处理
   - 失败的论文可以重试

3. **数据完整性**
   - 处理失败时状态会回滚到 `failed`
   - 不会影响其他论文的处理

4. **日志输出**
   - 所有处理步骤都有详细日志
   - 错误信息会完整输出

## 相关文档

- [批量处理论文](./process-papers.md)
- [数据库文档](../../database/README.md)
- [业务逻辑说明](../../BUSINESS_LOGIC.md)

## 相关文件

- [scripts/arxiv/process-paper.ts](../../scripts/arxiv/process-paper.ts) - 处理脚本主文件
- [src/lib/arxiv/fetch-paper.ts](../../src/lib/arxiv/fetch-paper.ts) - arXiv API 调用逻辑
- [prisma/schema.prisma](../../prisma/schema.prisma) - 数据库模型定义
